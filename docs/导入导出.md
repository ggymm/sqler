# Sqler 导入导出方案设计

## 1. 设计目标

### 1.1 核心原则

1. **进程隔离**：导入导出任务运行在独立子进程中，避免影响主应用稳定性
2. **高性能**：使用数据库原生高性能接口，而非逐行 SQL 执行
3. **可靠性**：支持断点续传、错误恢复、事务保护
4. **可观测性**：实时进度反馈、详细日志、性能指标统计

### 1.2 功能范围

**导入功能**：
- 支持格式：CSV、JSON、SQL
- 支持模式：替换、追加、更新、追加或更新、追加不更新
- 支持大文件：流式处理、分批导入
- 支持映射：列名映射、类型转换

**导出功能**：
- 支持格式：CSV、JSON、SQL
- 支持筛选：WHERE 条件、指定列
- 支持分表：按行数或文件大小拆分
- 支持压缩：可选 gzip 压缩

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                      主进程 (Main)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   UI 线程     │  │  任务管理器   │  │  进度监听器   │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                  │                  │          │
└─────────┼──────────────────┼──────────────────┼──────────┘
          │                  │                  │
          │                  │                  │
    用户操作            创建/监控任务        接收进度更新
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────┐
│              IPC 通信层 (Unix Socket / Named Pipe)        │
└─────────────────────────────────────────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────┐
│                  子进程 (Worker Process)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  任务接收器   │  │  数据处理器   │  │  进度报告器   │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                  │                  │          │
│         ▼                  ▼                  ▼          │
│  ┌───────────────────────────────────────────────────┐  │
│  │         数据库高性能接口 (LOAD DATA / COPY)         │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────┐
│   目标数据库         │
└─────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 主进程组件

**TaskManager（任务管理器）**
- 职责：
  - 创建和管理子进程
  - 分发导入/导出任务
  - 监控子进程健康状态
  - 处理任务取消和超时
- 状态维护：
  ```
  HashMap<TaskId, TaskHandle> {
      task_id: UUID,
      process: Child,
      status: TaskStatus,
      progress: Progress,
      created_at: DateTime,
  }
  ```

**ProgressMonitor（进度监听器）**
- 职责：
  - 接收子进程的进度更新
  - 聚合统计信息
  - 触发 UI 更新事件
- 更新频率：每 100ms 或每 1000 行

**IpcServer（IPC 服务器）**
- 职责：
  - 监听 Unix Socket / Named Pipe
  - 路由消息到对应的任务处理器
  - 处理连接异常

#### 2.2.2 子进程组件

**TaskExecutor（任务执行器）**
- 职责：
  - 解析任务配置
  - 初始化数据库连接
  - 调用对应的导入/导出处理器
  - 捕获异常并报告

**DataProcessor（数据处理器）**
- 职责：
  - 读取源文件（导入）或查询数据库（导出）
  - 数据格式转换和验证
  - 批量处理优化
  - 错误行记录和跳过

**ProgressReporter（进度报告器）**
- 职责：
  - 定时上报进度（处理行数、百分比、速度）
  - 上报错误和警告
  - 发送完成信号

---

## 3. 进程间通信设计

### 3.1 通信协议

#### 3.1.1 消息格式（JSON）

**任务请求**：
```
{
  "type": "task_request",
  "task_id": "uuid",
  "operation": "import" | "export",
  "config": {
    "source": {
      "type": "csv" | "json" | "sql",
      "path": "/path/to/file",
      "encoding": "utf-8",
      "delimiter": ",",       // CSV only
      "has_header": true      // CSV only
    },
    "target": {
      "data_source": {
        "id": "uuid",
        "kind": "MySQL",
        "options": {...}
      },
      "database": "test_db",
      "table": "users",
      "mode": "replace" | "append" | "update"
    },
    "mapping": {
      "columns": {
        "source_col": "target_col"
      },
      "skip_columns": ["id"]
    },
    "options": {
      "batch_size": 1000,
      "max_errors": 100,
      "timeout": 3600,
      "transaction": true
    }
  }
}
```

**进度更新**：
```
{
  "type": "progress_update",
  "task_id": "uuid",
  "progress": {
    "status": "running" | "completed" | "failed" | "cancelled",
    "total_rows": 100000,
    "processed_rows": 45000,
    "success_rows": 44950,
    "error_rows": 50,
    "percentage": 45.0,
    "speed": 1500.5,          // rows per second
    "elapsed_seconds": 30.0,
    "estimated_seconds": 36.7
  }
}
```

**错误报告**：
```
{
  "type": "error_report",
  "task_id": "uuid",
  "error": {
    "severity": "warning" | "error" | "fatal",
    "code": "PARSE_ERROR",
    "message": "Invalid data format",
    "line": 12345,
    "column": "email",
    "data": "invalid@email"
  }
}
```

**完成通知**：
```
{
  "type": "task_completed",
  "task_id": "uuid",
  "result": {
    "status": "success" | "partial_success" | "failed",
    "total_rows": 100000,
    "success_rows": 99950,
    "error_rows": 50,
    "elapsed_seconds": 66.7,
    "error_log_path": "/path/to/errors.log"
  }
}
```

### 3.2 通信通道选择

#### Linux / macOS：Unix Domain Socket
```
路径：/tmp/sqler-ipc-{task_id}.sock
优点：
- 高性能（无需网络栈）
- 自动清理（进程结束时）
- 权限控制
```

#### Windows：Named Pipe
```
路径：\\.\pipe\sqler-ipc-{task_id}
优点：
- Windows 原生支持
- 类似 Unix Socket 性能
- 支持异步 I/O
```

### 3.3 连接建立流程

```
主进程                                子进程
  │                                    │
  ├─ 1. 创建 IPC Server (监听)         │
  │                                    │
  ├─ 2. 启动子进程 ────────────────────>│
  │      传递 socket_path 参数         │
  │                                    │
  │                                    ├─ 3. 连接到 socket
  │<────────────────────────────────── │
  │                                    │
  ├─ 4. 发送任务配置 ───────────────────>│
  │                                    │
  │                                    ├─ 5. 开始执行
  │                                    │
  │<─ 6. 定期接收进度更新 ──────────────┤
  │                                    │
  │                                    ├─ 7. 发送完成信号
  │<────────────────────────────────── │
  │                                    │
  ├─ 8. 关闭连接                        │
  │                                    │
  └─ 9. 等待子进程退出                  └─ 退出
```

---

## 4. 任务生命周期管理

### 4.1 任务状态机

```
          创建任务
             │
             ▼
        ┌─────────┐
        │ Pending │ (等待启动)
        └────┬────┘
             │ 子进程启动成功
             ▼
        ┌─────────┐
        │ Running │ (执行中) ◄──┐
        └────┬────┘             │
             │                  │ 暂停/恢复
             ├──────────────────┘
             │
        ┌────┴────┬────────┬─────────┐
        │         │        │         │
        ▼         ▼        ▼         ▼
    Completed  Failed  Cancelled  Timeout
     (成功)    (失败)   (取消)    (超时)
```

### 4.2 任务操作

#### 4.2.1 创建任务
```
1. 验证任务配置（文件存在、权限检查、连接测试）
2. 生成唯一 task_id (UUID)
3. 创建 IPC Socket
4. 启动子进程：
   cargo run --bin sqler-worker -- \
     --socket /tmp/sqler-ipc-{task_id}.sock \
     --log-level info
5. 等待子进程连接（超时 5 秒）
6. 发送任务配置
7. 更新任务状态为 Running
```

#### 4.2.2 监控任务
```
1. 定期接收进度更新（非阻塞）
2. 检查子进程是否存活（每 1 秒）
3. 检查是否超时（根据 timeout 配置）
4. 更新内存中的任务状态
5. 触发 UI 更新事件
```

#### 4.2.3 取消任务
```
1. 发送取消信号到子进程（通过 IPC）
2. 等待子进程优雅退出（超时 5 秒）
3. 如果未响应，发送 SIGTERM（Linux/macOS）
4. 等待 3 秒后，强制 SIGKILL
5. 清理 IPC Socket
6. 更新任务状态为 Cancelled
```

#### 4.2.4 任务恢复（断点续传）
```
设计思路：
1. 子进程定期保存检查点到文件：
   /tmp/sqler-checkpoint-{task_id}.json
   {
     "task_id": "uuid",
     "processed_rows": 45000,
     "last_position": 45000,
     "timestamp": "2025-12-19T10:30:00Z"
   }
2. 任务失败或中断时，保留检查点文件
3. 用户选择"恢复任务"时：
   - 读取检查点文件
   - 从 last_position 继续处理
   - 跳过已处理的行
```

---

## 5. 并发控制与资源管理

### 5.1 并发限制

**全局限制**：
- 最大并发导入任务：2 个（CPU 密集型）
- 最大并发导出任务：3 个（I/O 密集型）
- 总并发上限：4 个

**任务队列**：
```
┌─────────────────────────────┐
│     等待队列 (Pending)       │
│  ┌────┐  ┌────┐  ┌────┐    │
│  │Task│  │Task│  │Task│    │
│  │ 1  │  │ 2  │  │ 3  │    │
│  └────┘  └────┘  └────┘    │
└────────────┬────────────────┘
             │ 调度器
             ▼
┌─────────────────────────────┐
│     执行槽 (Running)         │
│  ┌────┐  ┌────┐            │
│  │Task│  │Task│  [空闲]    │
│  │ A  │  │ B  │            │
│  └────┘  └────┘            │
└─────────────────────────────┘
```

### 5.2 资源限制

**内存限制**（每个子进程）：
- 默认：512 MB
- 可配置：256 MB ~ 2 GB
- 实现：通过操作系统 API（Linux: cgroups, macOS: resource limits）

**文件描述符**：
- 每个子进程打开文件数限制：100
- 避免文件句柄泄漏

**CPU 时间**：
- 单个任务最长执行时间：默认 1 小时
- 超时后自动终止并清理

---

## 6. 错误处理策略

### 6.1 错误分类

**致命错误（Fatal Error）**：
- 数据库连接失败
- 文件无法打开
- 配置解析错误
- 内存不足
→ 立即终止任务，回滚事务

**可恢复错误（Recoverable Error）**：
- 单行数据格式错误
- 类型转换失败
- 约束冲突
→ 记录错误，跳过该行，继续处理

**警告（Warning）**：
- 数据截断
- 默认值填充
- 跳过的列
→ 记录日志，正常处理

### 6.2 错误处理流程

```
处理数据行
    │
    ├─ 解析失败？
    │     │
    │     ├─ Yes ──> 错误计数 + 1
    │     │          │
    │     │          ├─ 超过阈值？──> 终止任务
    │     │          │
    │     │          └─ 未超过 ──> 记录到错误日志，跳过
    │     │
    │     └─ No ──> 继续
    │
    ├─ 插入数据库
    │     │
    │     ├─ 失败？
    │     │     │
    │     │     ├─ 连接错误 ──> 致命错误，终止
    │     │     │
    │     │     └─ 约束冲突 ──> 记录错误，根据模式处理
    │     │
    │     └─ 成功 ──> 成功计数 + 1
    │
    └─ 下一行
```

### 6.3 错误日志

**日志格式**（CSV）：
```
行号,错误类型,错误代码,错误消息,原始数据
12345,PARSE_ERROR,INVALID_DATE,"Invalid date format: '2025-13-40'","John,2025-13-40,invalid@email"
12380,CONSTRAINT_VIOLATION,DUPLICATE_KEY,"Duplicate entry '123' for key 'PRIMARY'","123,Jane,..."
```

**日志位置**：
```
~/.sqler/logs/import-errors-{task_id}.csv
~/.sqler/logs/export-errors-{task_id}.csv
```

---

## 7. 性能优化策略

### 7.1 批量处理

**批次大小**：
- 默认：1000 行/批次
- 自适应调整：
  - 内存充足 + 小行宽 → 增大到 5000
  - 内存紧张 + 大行宽 → 减小到 500

**批量插入**：
```sql
-- MySQL 示例
INSERT INTO users (name, email, age) VALUES
  ('User1', 'user1@example.com', 25),
  ('User2', 'user2@example.com', 30),
  ...
  ('User1000', 'user1000@example.com', 35);
```

### 7.2 数据库高性能接口（待设计）

**问题**：使用标准 SQL INSERT 逐行插入性能较差

**方案**（需要进一步讨论）：
- MySQL: `LOAD DATA INFILE` / `LOAD DATA LOCAL INFILE`
- PostgreSQL: `COPY FROM STDIN`
- SQLite: `.import` 或事务批量插入
- 其他数据库的原生批量导入接口

**设计要点**：
- 绕过 SQL 解析和优化器
- 直接写入数据文件或内存结构
- 性能提升：10x ~ 100x

**具体实现**：[待详细设计]

### 7.3 流式处理

**导入流程**：
```
文件读取器 ──> 行解析器 ──> 数据验证器 ──> 批量缓冲区 ──> 数据库写入器
  (异步)        (并行)        (过滤)         (聚合)         (批量)
```

**导出流程**：
```
数据库查询 ──> 结果集迭代器 ──> 格式转换器 ──> 文件写入器
  (游标)        (流式)            (序列化)       (缓冲写入)
```

### 7.4 并行化

**多文件并行导入**：
- 每个文件一个子进程
- 主进程协调，避免锁冲突

**单文件分段并行**（大文件）：
- 预扫描文件，按行分段
- 每个段一个线程处理
- 结果汇总到数据库

---

## 8. 用户交互设计

### 8.1 任务创建 UI

**步骤**：
1. 选择操作类型（导入/导出）
2. 选择源文件/目标表
3. 配置格式和选项
4. 预览数据（前 100 行）
5. 确认并启动

**配置保存**：
- 保存为模板：`~/.sqler/templates/import-users.json`
- 快速复用配置

### 8.2 进度展示 UI

**显示内容**：
```
┌──────────────────────────────────────────────────┐
│ 导入任务：users.csv → test_db.users              │
├──────────────────────────────────────────────────┤
│ 状态：运行中                                      │
│ 进度：[██████████████░░░░░░] 68% (68,430/100,000)│
│ 速度：1,250 行/秒                                 │
│ 已用时间：54.7 秒                                 │
│ 预计剩余：25.6 秒                                 │
│                                                  │
│ 成功：68,380 行                                   │
│ 失败：50 行 (查看错误日志)                        │
│                                                  │
│ [暂停] [取消] [查看日志]                          │
└──────────────────────────────────────────────────┘
```

### 8.3 结果通知

**完成后**：
- 桌面通知（可选）
- 任务列表更新状态
- 显示详细报告：
  - 总行数、成功数、失败数
  - 执行时间、平均速度
  - 错误日志下载链接

---

## 9. 测试策略

### 9.1 单元测试

- 数据解析器测试（各种格式和边界情况）
- 消息序列化/反序列化测试
- 错误处理逻辑测试

### 9.2 集成测试

- 子进程启动和通信测试
- 完整导入/导出流程测试
- 并发任务测试
- 任务取消和恢复测试

### 9.3 压力测试

- 大文件导入（1GB+）
- 高并发（10+ 任务同时运行）
- 异常场景（网络中断、磁盘满、进程被杀）

### 9.4 性能基准

**目标**：
- CSV 导入：>= 10,000 行/秒（普通服务器，小行宽）
- SQL 导出：>= 5,000 行/秒
- 内存占用：单任务 < 512 MB
- CPU 占用：单任务 < 100%（单核）

---

## 10. 实现路线图

### Phase 1：基础架构（Week 1-2）
- [ ] 设计和实现 IPC 通信协议
- [ ] 实现 TaskManager 和子进程管理
- [ ] 实现基本的进度反馈机制
- [ ] 单元测试覆盖核心组件

### Phase 2：CSV 导入导出（Week 3-4）
- [ ] 实现 CSV 解析器和生成器
- [ ] 实现标准 SQL INSERT 批量导入
- [ ] 实现 SQL SELECT 流式导出
- [ ] 错误处理和日志记录
- [ ] 集成测试

### Phase 3：高性能优化（Week 5-6）
- [ ] 调研和实现各数据库的高性能接口
- [ ] 性能测试和调优
- [ ] 并行化优化
- [ ] 断点续传功能

### Phase 4：JSON/SQL 格式支持（Week 7-8）
- [ ] 实现 JSON 导入导出
- [ ] 实现 SQL 文件导入
- [ ] 格式转换和验证
- [ ] 完整测试覆盖

### Phase 5：用户体验优化（Week 9-10）
- [ ] UI 集成和美化
- [ ] 任务模板功能
- [ ] 桌面通知
- [ ] 文档和用户指南

---

## 11. 待讨论问题

### 11.1 数据库高性能接口选型

**问题**：
各数据库有不同的高性能批量导入接口，需要设计统一的抽象层。

**待讨论**：
1. MySQL: `LOAD DATA INFILE` vs `LOAD DATA LOCAL INFILE` 的安全性和权限问题
2. PostgreSQL: `COPY FROM STDIN` 的数据格式（TEXT vs BINARY）
3. SQLite: 是否使用事务批量插入 vs `.import` 命令
4. 跨数据库统一接口设计
5. 性能 vs 兼容性的权衡

**下一步**：
请审阅以上设计，并就"数据库高性能接口"部分提供您的建议和最佳实践。

---

**文档版本**: v0.1
**最后更新**: 2025-12-19
**状态**: 设计中 - 待审阅
